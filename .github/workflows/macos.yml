name: macOS Build

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G Xcode -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"
    
    - name: Build
      run: |
        cd build
        cmake --build . --config Release
    
    - name: Create Installer
      run: |
        cd build
        
        # Create staging directory
        mkdir -p installer_stage/VST3 installer_stage/Standalone
        
        # Copy plugins
        cp -R Flarksiesis_artefacts/Release/VST3/Flarksiesis.vst3 installer_stage/VST3/ || true
        cp -R Flarksiesis_artefacts/Release/Standalone/Flarksiesis.app installer_stage/Standalone/ || true
        
        # Ad-hoc sign
        codesign --force --deep --sign - installer_stage/VST3/Flarksiesis.vst3 || true
        codesign --force --deep --sign - installer_stage/Standalone/Flarksiesis.app || true
        
        # Build component packages
        pkgbuild --root installer_stage/VST3 \
                 --identifier com.flarkaudio.flarksiesis.vst3 \
                 --version 2.0.0 \
                 --install-location /Library/Audio/Plug-Ins/VST3 \
                 Flarksiesis-VST3.pkg
        
        pkgbuild --root installer_stage/Standalone \
                 --identifier com.flarkaudio.flarksiesis.standalone \
                 --version 2.0.0 \
                 --install-location /Applications/flarkAUDIO \
                 Flarksiesis-Standalone.pkg
        
        # Create distribution XML
        cat > distribution.xml << 'DISTXML'
        <?xml version="1.0" encoding="utf-8"?>
        <installer-gui-script minSpecVersion="1">
            <title>Flarksiesis v2.0</title>
            <organization>com.flarkaudio</organization>
            <domains enable_localSystem="true"/>
            <options customize="always" require-scripts="false" hostArchitectures="x86_64,arm64"/>
            <pkg-ref id="com.flarkaudio.flarksiesis.vst3"/>
            <pkg-ref id="com.flarkaudio.flarksiesis.standalone"/>
            <choices-outline>
                <line choice="vst3"/>
                <line choice="standalone"/>
            </choices-outline>
            <choice id="vst3" title="VST3 Plugin">
                <pkg-ref id="com.flarkaudio.flarksiesis.vst3"/>
            </choice>
            <pkg-ref id="com.flarkaudio.flarksiesis.vst3" version="2.0.0">Flarksiesis-VST3.pkg</pkg-ref>
            <choice id="standalone" title="Standalone Application">
                <pkg-ref id="com.flarkaudio.flarksiesis.standalone"/>
            </choice>
            <pkg-ref id="com.flarkaudio.flarksiesis.standalone" version="2.0.0">Flarksiesis-Standalone.pkg</pkg-ref>
        </installer-gui-script>
        DISTXML
        
        # Build final installer
        productbuild --distribution distribution.xml \
                     --package-path . \
                     Flarksiesis-v2.0.0-macOS.pkg
    
    - name: Package artifacts
      run: |
        mkdir -p artifacts
        cp build/Flarksiesis-v2.0.0-macOS.pkg artifacts/ || true
        cp -r build/Flarksiesis_artefacts/Release/VST3/Flarksiesis.vst3 artifacts/ || true
        cp -r build/Flarksiesis_artefacts/Release/Standalone/Flarksiesis.app artifacts/ || true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Flarksiesis-macOS-Universal
        path: artifacts/
    
    - name: Create release archive
      if: github.event_name == 'release'
      run: |
        cd artifacts
        tar -czf Flarksiesis-macOS-Universal.tar.gz *
    
    - name: Upload to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: artifacts/Flarksiesis-macOS-Universal.tar.gz
        asset_name: Flarksiesis-macOS-Universal.tar.gz
        asset_content_type: application/gzip
